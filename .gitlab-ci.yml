stages:
  - build
  - deploy
  
build:
  image: maven:3.6.3-openjdk-11
  stage: build
  only:
  - dishant
  tags:
  - runner-4
  script:
    - export DATABASE_NAME=consumerscars
    - export DATABASE_USER=consumers
    - export DATABASE_PASSWORD="ubrt43W@@"
    - export DATABASE_HOST=34.93.210.170
    - export DATABASE_PORT=5432
    - mvn clean package -B
  artifacts:
    paths:
      - target/
deploy_job:
  image: google/cloud-sdk:alpine
  stage: deploy
  only:
  - dishant
  tags:
  - runner-4
  dependencies: 
    - build
  before_script:
  - "ServiceName=${CI_PROJECT_NAME/./-}"
  - "echo $ServiceName"
  - |
    cat <<EOF >> app.yaml
    runtime: java11
    env_variables:
      DATABASE_NAME: "$DATABASE_NAME"
      DATABASE_USER: "$DATABASE_USER"
      DATABASE_PASSWORD: "$DATABASE_PASSWORD"
      DATABASE_HOST: "$DATABASE_HOST"
      DATABASE_PORT: "$DATABASE_PORT"
    manual_scaling:
      instances: 1
    liveness_check:
      path: "/test"
    readiness_check:
      path: "/test"
    service: $ServiceName
    EOF
  - "cat app.yaml"
  - |
    cat <<EOF >> $CI_PIPELINE_ID.json
    {
      "type": "service_account",
      "project_id": "hu18-groupa-angular",
      "private_key_id": "a0c0b5757e01ec22433a227e7f66fbe5d4a08bb4",
      "private_key": "-----BEGIN PRIVATE KEY-----\nMIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQDKyAhkdFwJDamT\n5Hr6UTXkYp6BuGteKlxQnqDy+k7CBaXenI9kWMTKys9u8T8T43T6Nz4KkntjTSXy\n/QIogGtdHZgG7nbrDxbgYw94O16dDtI11UmcaaWswxb+8em8M1/qE3p7QCNdmxdK\nLmcGQoRoq7i5Bf8BqjApiBKSPx8XHgddWmoUURP3zyvnMaG5dOJkl771S1FSQbGv\nD5gWPVn42OWSGHykW3dgKpamrWMgFB1EIG8IefBjfSrTgSp78iAD8HPwYCBnFJQA\nsBa8ILSJRhR6HthTwlY/l5ShpNjs2r9t/XRHqUz+MwGVa7dJCzitk73C+nuurwUQ\nvjyorVXjAgMBAAECggEALatveHBcag2Rq6VBrS6tHIq5eC24wLR5pg6T4SVOp5Pu\nD3zjLo5vg9y5axsaQbhwmAnpByiGcY7mhRtGaSjDBW2s16LNVZNIa7Djwwhb/rNf\n1I/8zCVfEtG9VB3XrnNDnsxUQX3oeSR80lAxE8/XUluadtFK5W0W+8ORqy5cKjBK\nTOLIxNaRTMiTEuq0jyMPMovQeQg3Vc6EPOQm1/4CxVHKnCJg2d7g4OyMojKejwIc\n7jQL6z90Vrx16au+a8BL4fkpvIQLFkEj4pk/gVck4hZb3vlAGnG/Yf07nqSZRQLi\nVw+EQmllc4xgQi9vZdw0VReQT07k9YBTz1af1v4qQQKBgQDzjFbhj6AwaWMk4i0q\n7zJv/PvNc19XE2pLUb+pURXrmYCG0nru17/aKJ47yihzogxpkkWqK+I0ff3J7YDm\nKA1o7wJZzIdloj9qQxx3/kGMAOI8/USp29L+OmxwxTPb4nsPpNj9zDYaULzrI2aC\n50egs9AjzWRvmWCQru/w7AjALwKBgQDVJh7FBXczJIVIc11p/ijx9er6/1fIVBuh\njZd29D74ptzhfXt5DSIEuv4JS8/87FPPKZTwcUcgG5j3nfWU0D0bf/XO1lJsVVcj\nSwQc0tjOdeEr5WItBFI+STdkUG92swaeRODVFB6PjnzSEJ7qeSagI70gA8C1kEn9\n5Hgk7WFEjQKBgFPg0o9OsuHZee7bAqlVxi4xl9tTT9OieSpFllfO+Fiy/kPwu6wE\nnCubb5ux7Sqd9d5qJRoNkRN5DO39oTYjNzMblditizgin+qOAIEHDTYVm9VbeMlz\nTwCFyJEyKcEiCDYEFUObkEqR4e6tu4F7+/xJ0XZzJ5MT5OEPjs2PzRe7AoGBAIkR\n752hyyrvZGrYDY2Y7XnUPF1XEXt5Yx98L5hGr6w1mjvD90A8StEh8zXFNCahT7Ac\nPHR3VFb4iGFMil49n95sZoWx2+Vg6B2BI07p5JS4x6nz5DOw4La/XMi81UFPFYV4\nI+HDA3gsGGb6W0fLyyQWd4v7/dSEyqBkaULOCMwNAoGBAJDelGHPMRpqWCUEyT9g\n0dmYsxX9xXto+mJDNZ949tpx8+9JZNnHHbDUzrHmZEbwShKGp3gLSENTpyndbvNm\nYqmw1G20Q4nuWKQsy2egn1XTzB9GZSCJd7k1MgJJsPp4aHSJl540RQuTIMPfVbSl\nuhFUSSTUxA02MmEykZh95xWQ\n-----END PRIVATE KEY-----\n",
      "client_email": "huappengine@hu18-groupa-angular.iam.gserviceaccount.com",
      "client_id": "104726124207565481899",
      "auth_uri": "https://accounts.google.com/o/oauth2/auth",
      "token_uri": "https://oauth2.googleapis.com/token",
      "auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",
      "client_x509_cert_url": "https://www.googleapis.com/robot/v1/metadata/x509/huappengine%40hu18-groupa-angular.iam.gserviceaccount.com"
    }
    EOF
  script:
  - gcloud auth activate-service-account --key-file $CI_PIPELINE_ID.json
  - gcloud --project hu18-groupa-angular app deploy target/*.jar --appyaml app.yaml --version v1
  - url=$(gcloud app services browse $ServiceName --no-launch-browser --project hu18-groupa-angular)
  - echo $url
  after_script:
  - rm $CI_PIPELINE_ID.json